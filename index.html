<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>FS MASTER COMMAND | PRECISION MATRIX v1.78</title>
    <link rel="stylesheet" href="style.css?v=1.78">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;900&display=swap" rel="stylesheet">
    <style>
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 69, 0, 0.4); }
            70% { box-shadow: 0 0 0 15px rgba(255, 69, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 69, 0, 0); }
        }
        .data-label { opacity: 0.6; font-size: 0.8em; text-transform: uppercase; }
        .data-value { font-weight: 900; color: #ffd700; }
        
        /* Trophy Section Styling */
        .trophy-matrix-frame {
            width: 100%;
            height: 500px;
            border: none;
            border-radius: 8px;
            background: transparent;
        }

        /* Module Styles */
        .blade-header { display: flex; justify-content: space-between; border-bottom: 2px solid #ffd700; padding-bottom: 15px; margin-bottom: 20px; color: #fff; }
        .matrix-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; color: #fff; }
        .field-card, .animal-card, .factory-card { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,215,0,0.1); border-radius: 10px; padding: 15px; }
        .harvest-ready { border: 2px solid #22c55e; box-shadow: 0 0 15px rgba(124, 252, 0, 0.15); }
        .field-top, .card-top { display: flex; justify-content: space-between; font-weight: 900; font-size: 0.75rem; margin-bottom: 12px; }
        .owner-tag.green { color: #7cfc00; }
        .owner-tag.gold { color: #ffd700; }
        .field-crop { font-size: 1.3rem; font-weight: 800; letter-spacing: 1px; color: #fff; }
        .field-status { font-size: 0.75rem; font-weight: 900; margin-bottom: 15px; }
        .telemetry-grid, .telemetry-bars, .storage-matrix { display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px; }
        .stat-unit label, .telemetry-bars label, .storage-matrix label { font-size: 0.65rem; color: #aaa; text-transform: uppercase; display: block; margin-bottom: 4px; font-weight: 900; }
        .bar-bg { height: 5px; background: #111; border-radius: 3px; overflow: hidden; }
        .bar-fill { height: 100%; transition: width 1.5s ease-in-out; }
        .requirement-tags { display: flex; flex-wrap: wrap; gap: 5px; }
        .req-badge { font-size: 0.65rem; font-weight: 900; padding: 3px 8px; border-radius: 4px; color: #000; }
        .req-badge.lime { background: #fff; }
        .req-badge.plow { background: #ff4500; color: #fff; }
        .req-badge.roll { background: #00d4ff; color: #fff; }
        .req-badge.mulched { background: #8b4513; color: #fff; }
        .production-stats { margin-top: 15px; border-top: 1px solid rgba(255,255,255,0.05); padding-top: 10px; font-size: 0.75rem; }
        .stat-line { display: flex; justify-content: space-between; margin-bottom: 4px; font-weight: 600; }
        .production-lines { margin-bottom: 15px; font-size: 0.75rem; display: flex; flex-direction: column; gap: 5px; }
        .bar-info { display: flex; justify-content: space-between; font-size: 0.7rem; font-weight: 700; margin-bottom: 4px; }
    </style>
</head>
<body>
    <div class="dashboard-container" style="width: 90%; margin: 20px auto;">

        <header class="glass-panel header-main">
            <div class="header-content">
                <div class="map-branding">
                    <div class="image-container">
                        <img id="activeMapImage" src="http://176.57.165.81:8080/feed/dedicated-server-stats-map.jpg?code=DIaoyx8jutkGtlDr" alt="Live Map">
                        <div class="slot-badge" id="currentSlotLabel">MATRIX v1.78</div>
                    </div>
                    <div class="header-text">
                        <h1 id="serverNameDisplay">Werewolf Red Operations</h1>
                        <div class="status-bar">
                            <span id="mapDisplay">Map: Detecting...</span> | <span id="gameClock">Time: 00:00</span>
                        </div>
                    </div>
                </div>
                <div class="selector-box">
                    <select id="saveSelector">
                        <option value="2" selected>Saved Game 2 (Texas)</option>
                        <option value="5">Saved Game 5 (Missouri)</option>
                        <option value="1">Saved Game 1</option>
                    </select>
                </div>
            </div>
        </header>

        <section class="ops-matrix">
            <article class="glass-panel card">
                <div class="card-tag">üí∞ werewolf3788 (FARM 1)</div>
                <div id="kevinFinance" class="telemetry-body">$0.00</div>
            </article>
            <article class="glass-panel card">
                <div class="card-tag">üí∞ raymystro (FARM 2)</div>
                <div id="rayFinance" class="telemetry-body">$0.00</div>
            </article>
            <article class="glass-panel card">
                <div class="card-tag">üë• LIVE TEAM</div>
                <div id="playerLog" class="telemetry-body">Scanning...</div>
            </article>
        </section>

        <main class="data-matrix triple-col">
            <article class="glass-panel card" id="module-container-1">
                <div id="fieldModule" class="field-data-blade">
                    <div class="blade-header">
                        <h2>üåæ MODULE 1: LAND & SOIL PREPARATION MATRIX</h2>
                        <span id="fieldCount" class="badge">INITIALIZING DEEP SCAN...</span>
                    </div>
                    <div id="fieldMatrixContainer" class="matrix-grid scroll-list main-scroll"></div>
                </div>
            </article>
            <article class="glass-panel card" id="module-container-2">
                <div id="animalModule" class="animal-data-blade">
                    <div class="blade-header">
                        <h2>üêæ MODULE 2: LIVESTOCK BIOMETRICS</h2>
                        <span id="animalCount" class="badge">INITIALIZING SCAN...</span>
                    </div>
                    <div id="animalMatrixContainer" class="matrix-grid scroll-list main-scroll"></div>
                </div>
            </article>
            <article class="glass-panel card" id="module-container-3">
                <div id="factoryModule" class="factory-data-blade">
                    <div class="blade-header">
                        <h2>üèóÔ∏è MODULE 3: PRODUCTION CHAINS</h2>
                        <span id="factoryCount" class="badge">ANALYZING WAREHOUSES...</span>
                    </div>
                    <div id="factoryMatrixContainer" class="matrix-grid scroll-list main-scroll"></div>
                </div>
            </article>
        </main>

        <section class="glass-panel card fleet-section" style="margin-top: 20px;">
            <div class="card-tag">üöú ACTIVE FLEET TELEMETRY</div>
            <div id="fleetLog" class="telemetry-grid">Initializing Truth Sync...</div>
        </section>

        <section class="glass-panel card mods-section" style="margin-top: 20px;">
            <div class="card-tag">üì¶ ACTIVE MODS & DLC LIBRARY</div>
            <div id="modsLog" class="telemetry-grid" style="max-height: 300px; overflow-y: auto; display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 10px;">Scanning Library...</div>
        </section>

        <section class="glass-panel card trophy-section" style="margin-top: 20px; padding: 0; overflow: hidden;">
    <div class="card-tag" style="margin: 15px;">üèÜ PSN UPLINK: RAYMYSTRO PROGRESSION</div>
    <iframe src="https://kfruti88.github.io/Farming-Simulator/ray_trophies.html" class="trophy-matrix-frame"></iframe>
</section>

    </div>

    <script>
        // Main Dashboard Logic
        const REPO_ROOT = "."; // Relative path to root
        
        document.addEventListener('DOMContentLoaded', () => {
            const selector = document.getElementById('saveSelector');
            selector.addEventListener('change', () => loadDashboard(selector.value));
            loadDashboard(selector.value); // Initial load
            
            // Refresh every 60s
            setInterval(() => loadDashboard(selector.value), 60000);
        });

        async function loadDashboard(slotId) {
            const path = `${REPO_ROOT}/saved-game-${slotId}`;
            console.log(`Loading Data from Slot ${slotId}...`);

            // 1. Update Header & Money
            updateServerStats();
            updateFinancials(path);

            // 2. Sync Modules
            syncFieldBlade(path);
            syncAnimalBlade(path);
            syncFactoryBlade(path);
            
            // 3. Sync Fleet (Custom implementation for index.html)
            syncFleet(path);
        }

        async function updateServerStats() {
            try {
                const res = await fetch(`${REPO_ROOT}/dedicated_server/dedicated-server-stats.xml?v=${Date.now()}`);
                const xml = new DOMParser().parseFromString(await res.text(), "text/xml");
                const server = xml.getElementsByTagName("Server")[0];
                
                document.getElementById('serverNameDisplay').textContent = server.getAttribute("name");
                document.getElementById('mapDisplay').textContent = `Map: ${server.getAttribute("mapName")} (v${server.getAttribute("version")})`;
                
                // Format Time
                const rawTime = parseInt(server.getAttribute("dayTime"));
                const hours = Math.floor(rawTime / 60 / 60);
                const minutes = Math.floor((rawTime / 60) % 60);
                document.getElementById('gameClock').textContent = `Time: ${hours.toString().padStart(2,'0')}:${minutes.toString().padStart(2,'0')}`;
                
                // Update Players
                const slots = xml.getElementsByTagName("Slots")[0];
                const used = slots.getAttribute("numUsed");
                document.getElementById('playerLog').textContent = `${used} / ${slots.getAttribute("capacity")} ONLINE`;

                // Sync Mods
                syncMods(xml);
            } catch(e) { console.warn("Server Stats Sync Failed", e); }
        }

        async function updateFinancials(path) {
            try {
                const res = await fetch(`${path}/farms.xml?v=${Date.now()}`);
                const xml = new DOMParser().parseFromString(await res.text(), "text/xml");
                const farms = Array.from(xml.getElementsByTagName("farm"));
                
                const f1 = farms.find(f => f.getAttribute("farmId") === "1");
                const f2 = farms.find(f => f.getAttribute("farmId") === "2");
                
                const fmt = (val) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(val || 0);
                
                document.getElementById('kevinFinance').textContent = fmt(f1?.getAttribute("money"));
                document.getElementById('rayFinance').textContent = fmt(f2?.getAttribute("money"));
            } catch(e) { console.warn("Financial Sync Failed", e); }
        }

        // --- MODULE 1: FIELDS ---
        async function syncFieldBlade(gitPath) {
            try {
                const [fieldsRes, landRes] = await Promise.all([
                    fetch(`${gitPath}/fields.xml?v=${Date.now()}`),
                    fetch(`${gitPath}/farmland.xml?v=${Date.now()}`)
                ]);
                const fieldsXml = new DOMParser().parseFromString(await fieldsRes.text(), "text/xml");
                const fieldData = Array.from(fieldsXml.getElementsByTagName("field"));
                
                document.getElementById('fieldCount').textContent = `${fieldData.length} ACTIVE ZONES`;
                document.getElementById('fieldMatrixContainer').innerHTML = fieldData.map(f => {
                const activeFields = fieldData.filter(f => (f.getAttribute("fruitType") || "FALLOW").toUpperCase() !== "FALLOW");

                document.getElementById('fieldCount').textContent = `${activeFields.length} ACTIVE ZONES`;
                document.getElementById('fieldMatrixContainer').innerHTML = activeFields.map(f => {
                    const id = f.getAttribute("id");
                    const crop = (f.getAttribute("fruitType") || "FALLOW").toUpperCase();
                    const stage = parseInt(f.getAttribute("growthState") || 0);
                    const fert = (parseFloat(f.getAttribute("fertilizedLevel") || 0) * 100).toFixed(0);
                    const needsLime = f.getAttribute("needsLime") === "true";
                    const isReady = stage >= 6; 
                    
                    return `<div class="field-card ${isReady ? 'harvest-ready' : ''}">
                        <div class="field-top"><span class="field-id">ZONE ${id}</span></div>
                        <div class="field-main-info"><div class="field-crop">${crop}</div></div>
                        <div class="telemetry-grid">
                            <div class="stat-unit"><label>Fert: ${fert}%</label><div class="bar-bg"><div class="bar-fill" style="width:${fert}%; background:${fert>=100?'#22c55e':'#ffd700'}"></div></div></div>
                        </div>
                        <div class="requirement-tags">${needsLime ? '<span class="req-badge lime">LIME</span>' : ''}</div>
                    </div>`;
                }).join('');
            } catch (e) { console.warn("Field Sync Failed"); }
        }

        // --- MODULE 2: ANIMALS ---
        async function syncAnimalBlade(gitPath) {
            try {
                const res = await fetch(`${gitPath}/animals.xml?v=${Date.now()}`);
                const xml = new DOMParser().parseFromString(await res.text(), "text/xml");
                const animals = Array.from(xml.getElementsByTagName("animal"));
                
                document.getElementById('animalCount').textContent = `${animals.length} ACTIVE HEAD`;
                document.getElementById('animalMatrixContainer').innerHTML = animals.map(a => {
                    const type = a.getAttribute("type").split('_').pop().toUpperCase();
                    const health = (parseFloat(a.getAttribute("health") || 0) * 100).toFixed(0);
                    return `<div class="animal-card">
                        <div class="card-top"><span class="type-tag">${type}</span></div>
                        <div class="telemetry-bars"><label>Health: ${health}%</label><div class="bar-bg"><div class="bar-fill" style="width:${health}%; background:#22c55e"></div></div></div>
                    </div>`;
                }).join('');
            } catch (e) { console.warn("Animal Sync Failed"); }
        }

        // --- MODULE 3: FACTORIES ---
        async function syncFactoryBlade(gitPath) {
            try {
                const res = await fetch(`${gitPath}/placeables.xml?v=${Date.now()}`);
                const xml = new DOMParser().parseFromString(await res.text(), "text/xml");
                const factories = Array.from(xml.getElementsByTagName("productionPoint"));
                
                document.getElementById('factoryCount').textContent = `${factories.length} FACILITIES`;
                document.getElementById('factoryMatrixContainer').innerHTML = factories.map(f => {
                    const name = f.parentElement.getAttribute("filename").split('/').pop().replace('.xml','').toUpperCase();
                    return `<div class="factory-card"><div class="card-top"><span class="factory-id">${name}</span></div></div>`;
                }).join('');
            } catch (e) { console.warn("Factory Sync Failed"); }
        }

        // --- FLEET SYNC ---
        async function syncFleet(gitPath) {
            try {
                const res = await fetch(`${gitPath}/vehicles.xml?v=${Date.now()}`);
                const xml = new DOMParser().parseFromString(await res.text(), "text/xml");
                const vehicles = Array.from(xml.getElementsByTagName("vehicle")).filter(v => v.getAttribute("farmId") !== "0");
                
                document.getElementById('fleetLog').innerHTML = vehicles.map(v => {
                    const name = v.getAttribute("filename").split('/').pop().replace('.xml','').toUpperCase();
                    const farm = v.getAttribute("farmId") === "1" ? "KEVIN" : "RAY";
                    const fuel = parseFloat(v.getElementsByTagName("fillUnit")[0]?.getAttribute("fillLevel") || 0).toFixed(0);
                    return `<div style="display:flex; justify-content:space-between; border-bottom:1px solid #333; padding:5px;">
                        <span>${name}</span><span style="color:${farm==='KEVIN'?'#7cfc00':'#ffd700'}">${farm}</span><span>${fuel}L Fuel</span>
                    </div>`;
                }).join('');
            } catch(e) { console.warn("Fleet Sync Failed"); }
        }

        // --- MODS SYNC ---
        function syncMods(xml) {
            const mods = Array.from(xml.getElementsByTagName("Mod"));
            const container = document.getElementById('modsLog');
            
            container.innerHTML = mods.map(m => {
                const name = m.textContent;
                const author = m.getAttribute("author");
                const version = m.getAttribute("version");
                return `<div style="background:rgba(255,255,255,0.05); padding:8px; border-radius:4px; border-left: 3px solid #ffd700;">
                    <div style="font-weight:bold; color:#fff; font-size:0.8rem;">${name}</div>
                    <div style="font-size:0.7rem; color:#aaa;">v${version} | ${author}</div>
                </div>`;
            }).join('') || '<div style="padding:10px; color:#aaa;">No Active Mods Detected</div>';
        }
    </script>
</body>
</html>
