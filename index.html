<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>FS MASTER COMMAND | PRECISION MATRIX v1.78</title>
    <link rel="stylesheet" href="style.css?v=1.78">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;900&display=swap" rel="stylesheet">
    <style>
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 69, 0, 0.4); }
            70% { box-shadow: 0 0 0 15px rgba(255, 69, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 69, 0, 0); }
        }
        .data-label { opacity: 0.6; font-size: 0.8em; text-transform: uppercase; }
        .data-value { font-weight: 900; color: #ffd700; }
        
        /* Trophy Section Styling */
        .trophy-matrix-frame {
            width: 100%;
            height: 500px;
            border: none;
            border-radius: 8px;
            background: transparent;
        }

        /* Module Styles */
        .blade-header { display: flex; justify-content: space-between; border-bottom: 2px solid #ffd700; padding-bottom: 15px; margin-bottom: 20px; color: #fff; }
        .matrix-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; color: #fff; }
        .field-card, .animal-card, .factory-card { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,215,0,0.1); border-radius: 10px; padding: 15px; }
        .harvest-ready { border: 2px solid #22c55e; box-shadow: 0 0 15px rgba(124, 252, 0, 0.15); }
        .field-top, .card-top { display: flex; justify-content: space-between; font-weight: 900; font-size: 0.75rem; margin-bottom: 12px; }
        .owner-tag.green { color: #7cfc00; }
        .owner-tag.gold { color: #ffd700; }
        .field-crop { font-size: 1.3rem; font-weight: 800; letter-spacing: 1px; color: #fff; }
        .field-status { font-size: 0.75rem; font-weight: 900; margin-bottom: 15px; }
        .telemetry-grid, .telemetry-bars, .storage-matrix { display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px; }
        .stat-unit label, .telemetry-bars label, .storage-matrix label { font-size: 0.65rem; color: #aaa; text-transform: uppercase; display: block; margin-bottom: 4px; font-weight: 900; }
        .bar-bg { height: 5px; background: #111; border-radius: 3px; overflow: hidden; }
        .bar-fill { height: 100%; transition: width 1.5s ease-in-out; }
        .requirement-tags { display: flex; flex-wrap: wrap; gap: 5px; }
        .req-badge { font-size: 0.65rem; font-weight: 900; padding: 3px 8px; border-radius: 4px; color: #000; }
        .req-badge.lime { background: #fff; }
        .req-badge.plow { background: #ff4500; color: #fff; }
        .req-badge.roll { background: #00d4ff; color: #fff; }
        .req-badge.mulched { background: #8b4513; color: #fff; }
        .production-stats { margin-top: 15px; border-top: 1px solid rgba(255,255,255,0.05); padding-top: 10px; font-size: 0.75rem; }
        .stat-line { display: flex; justify-content: space-between; margin-bottom: 4px; font-weight: 600; }
        .production-lines { margin-bottom: 15px; font-size: 0.75rem; display: flex; flex-direction: column; gap: 5px; }
        .bar-info { display: flex; justify-content: space-between; font-size: 0.7rem; font-weight: 700; margin-bottom: 4px; }
        .animal-card.warning { border-color: #ff4d4d; box-shadow: inset 0 0 10px rgba(255, 77, 77, 0.1); }
        .bee-card { border-color: #ffd700; background: rgba(255, 215, 0, 0.05); }
        .type-tag { color: #ffd700; letter-spacing: 1px; }
        .age-tag { color: #888; }
        .p-line { margin-bottom: 2px; }
    </style>
</head>
<body>
    <div class="dashboard-container" style="width: 90%; margin: 20px auto;">

        <header class="glass-panel header-main">
            <div class="header-content">
                <div class="map-branding">
                    <div class="image-container">
                        <img id="activeMapImage" src="dedicated_server/map.jpg" alt="Live Map">
                        <div class="slot-badge" id="currentSlotLabel">MATRIX v1.78</div>
                    </div>
                    <div class="header-text">
                        <h1 id="serverNameDisplay">Werewolf Red Operations</h1>
                        <div class="status-bar">
                            <span id="mapDisplay">Map: Detecting...</span> | <span id="gameClock">Time: 00:00</span>
                        </div>
                    </div>
                </div>
                <div class="selector-box">
                    <select id="saveSelector">
                        <option value="6" selected>Saved Game 6 (Four Fields)</option>
                        <option value="2">Saved Game 2 (Texas)</option>
                        <option value="5">Saved Game 5 (Missouri)</option>
                        <option value="1">Saved Game 1</option>
                    </select>
                </div>
            </div>
        </header>

        <section class="ops-matrix">
            <article class="glass-panel card">
                <div class="card-tag">üí∞ werewolf3788 (FARM 1)</div>
                <div id="kevinFinance" class="telemetry-body">$0.00</div>
            </article>
            <article class="glass-panel card">
                <div class="card-tag">üí∞ raymystro (FARM 2)</div>
                <div id="rayFinance" class="telemetry-body">$0.00</div>
            </article>
            <article class="glass-panel card">
                <div class="card-tag">üë• LIVE TEAM</div>
                <div id="playerLog" class="telemetry-body">Scanning...</div>
            </article>
        </section>

        <main class="data-matrix triple-col">
            <article class="glass-panel card" id="module-container-1">
                <div id="fieldModule" class="field-data-blade">
                    <div class="blade-header">
                        <h2>üåæ MODULE 1: LAND & SOIL PREPARATION MATRIX</h2>
                        <span id="fieldCount" class="badge">INITIALIZING DEEP SCAN...</span>
                    </div>
                    <div id="fieldMatrixContainer" class="matrix-grid scroll-list main-scroll"></div>
                </div>
            </article>
            <article class="glass-panel card" id="module-container-2">
                <div id="animalModule" class="animal-data-blade">
                    <div class="blade-header">
                        <h2>üêæ MODULE 2: LIVESTOCK BIOMETRICS</h2>
                        <span id="animalCount" class="badge">INITIALIZING SCAN...</span>
                    </div>
                    <div id="animalMatrixContainer" class="matrix-grid scroll-list main-scroll"></div>
                </div>
            </article>
            <article class="glass-panel card" id="module-container-3">
                <div id="factoryModule" class="factory-data-blade">
                    <div class="blade-header">
                        <h2>üèóÔ∏è MODULE 3: PRODUCTION CHAINS</h2>
                        <span id="factoryCount" class="badge">ANALYZING WAREHOUSES...</span>
                    </div>
                    <div id="factoryMatrixContainer" class="matrix-grid scroll-list main-scroll"></div>
                </div>
            </article>
        </main>

        <section class="glass-panel card fleet-section" style="margin-top: 20px;">
            <div class="card-tag">üöú ACTIVE FLEET TELEMETRY</div>
            <div id="fleetLog" class="telemetry-grid">Initializing Truth Sync...</div>
        </section>

        <section class="glass-panel card server-info-section" style="margin-top: 20px;">
            <div class="card-tag">‚ÑπÔ∏è SERVER DETAILS</div>
            <div class="server-details-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; padding: 15px; color: #fff;">
                <div><label style="color:#aaa; font-size:0.7rem; font-weight:900; display:block; margin-bottom:4px;">SERVER NAME</label><div id="detail-name" style="font-weight:bold;">Loading...</div></div>
                <div><label style="color:#aaa; font-size:0.7rem; font-weight:900; display:block; margin-bottom:4px;">GAME</label><div id="detail-game">Farming Simulator 22</div></div>
                <div><label style="color:#aaa; font-size:0.7rem; font-weight:900; display:block; margin-bottom:4px;">LOCATION</label><div>United States</div></div>
                <div><label style="color:#aaa; font-size:0.7rem; font-weight:900; display:block; margin-bottom:4px;">MAP</label><div id="detail-map">Loading...</div></div>
                <div><label style="color:#aaa; font-size:0.7rem; font-weight:900; display:block; margin-bottom:4px;">MAP SIZE</label><div id="detail-size">Loading...</div></div>
                <div><label style="color:#aaa; font-size:0.7rem; font-weight:900; display:block; margin-bottom:4px;">DISCORD</label><div><a href="https://discord.gg/sMeYydGGyb" target="_blank" style="color:#ffd700; text-decoration:none;">Join Community</a></div></div>
                <div style="grid-column: 1 / -1;"><label style="color:#aaa; font-size:0.7rem; font-weight:900; display:block; margin-bottom:4px;">TAGS</label><div style="font-size:0.8rem;">Farming, Grain, Easy Mode, Crossplay, PC, Console, Mods</div></div>
            </div>
        </section>

        <section class="glass-panel card mods-section" style="margin-top: 20px;">
            <div class="card-tag">üì¶ ACTIVE MODS & DLC LIBRARY</div>
            <div id="modsLog" class="telemetry-grid" style="max-height: 300px; overflow-y: auto; display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 10px;">Scanning Library...</div>
            <div class="card-tag" style="margin-top: 15px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 10px;">üìö CURATED MOD LIST (GOOGLE SHEET)</div>
            <div id="sheetModsLog" class="telemetry-grid" style="max-height: 300px; overflow-y: auto; display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 10px;">Loading Sheet...</div>
        </section>

        <section class="glass-panel card trophy-section" style="margin-top: 20px;">
            <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                <div style="flex: 1; min-width: 300px;">
                    <div class="card-tag">üèÜ PSN: raymystro (OneLIVIDMAN)</div>
                    <div id="trophyLogRay" class="telemetry-grid" style="max-height: 300px; overflow-y: auto; padding: 10px;">Initializing...</div>
                </div>
                <div style="flex: 1; min-width: 300px;">
                    <div class="card-tag">üèÜ PSN: werewolf3788 (Werewolf3788)</div>
                    <div id="trophyLogKevin" class="telemetry-grid" style="max-height: 300px; overflow-y: auto; padding: 10px;">Initializing...</div>
                </div>
            </div>
        </section>

    </div>

    <script>
        // Main Dashboard Logic
        const REPO_ROOT = "."; // Relative path to root
        
        document.addEventListener('DOMContentLoaded', () => {
            const selector = document.getElementById('saveSelector');
            selector.addEventListener('change', () => loadDashboard(selector.value));
            loadDashboard(selector.value); // Initial load
            
            // Refresh every 60s
            setInterval(() => loadDashboard(selector.value), 60000);
        });

        async function loadDashboard(slotId) {
            const path = `${REPO_ROOT}/saved-game-${slotId}`;
            console.log(`Loading Data from Slot ${slotId}...`);

            // 1. Update Header & Money
            updateServerStats();
            updateFinancials(path);

            // 2. Sync Modules
            syncFieldBlade(path);
            syncAnimalBlade(path);
            syncFactoryBlade(path);
            
            // 3. Sync Fleet (Custom implementation for index.html)
            syncFleet(path);

            // 4. Sync Trophies
            syncTrophies();

            // 5. Sync Mod Sheet
            syncModSheet();
        }

        async function updateServerStats() {
            try {
                const res = await fetch(`${REPO_ROOT}/dedicated_server/dedicated-server-stats.xml?v=${Date.now()}`);
                if (!res.ok) throw new Error("Stats missing");
                const xml = new DOMParser().parseFromString(await res.text(), "text/xml");
                const server = xml.getElementsByTagName("Server")[0];

                // Refresh Map Image
                document.getElementById('activeMapImage').src = `${REPO_ROOT}/dedicated_server/map.jpg?v=${Date.now()}`;
                
                document.getElementById('serverNameDisplay').textContent = server.getAttribute("name");
                document.getElementById('mapDisplay').textContent = `Map: ${server.getAttribute("mapName")} (v${server.getAttribute("version")})`;
                
                // Format Time
                const rawTime = parseInt(server.getAttribute("dayTime"));
                const hours = Math.floor(rawTime / 60 / 60);
                const minutes = Math.floor((rawTime / 60) % 60);
                document.getElementById('gameClock').textContent = `Time: ${hours.toString().padStart(2,'0')}:${minutes.toString().padStart(2,'0')}`;
                
                // Update Players
                const slots = xml.getElementsByTagName("Slots")[0];
                const used = slots.getAttribute("numUsed");
                document.getElementById('playerLog').textContent = `${used} / ${slots.getAttribute("capacity")} ONLINE`;

                // Update Server Details Module
                document.getElementById('detail-name').textContent = server.getAttribute("name");
                document.getElementById('detail-game').textContent = server.getAttribute("game");
                document.getElementById('detail-map').textContent = server.getAttribute("mapName");
                const size = parseInt(server.getAttribute("mapSize"));
                const sizeLabel = size === 2048 ? "Standard (1x)" : (size === 4096 ? "4x Map" : (size === 8192 ? "16x Map" : `${size}m`));
                document.getElementById('detail-size').textContent = sizeLabel;

                // Sync Mods
                syncMods(xml);
            } catch(e) { 
                console.warn("Server Stats Sync Failed", e);
                document.getElementById('serverNameDisplay').textContent = "OFFLINE / NO DATA";
                document.getElementById('modsLog').innerHTML = "<div style='padding:10px; color:#aaa;'>Waiting for server data...</div>";
            }
        }

        async function updateFinancials(path) {
            try {
                const res = await fetch(`${path}/farms.xml?v=${Date.now()}`);
                if (!res.ok) throw new Error("Farms missing");
                const xml = new DOMParser().parseFromString(await res.text(), "text/xml");
                const farms = Array.from(xml.getElementsByTagName("farm"));
                
                const f1 = farms.find(f => f.getAttribute("farmId") === "1");
                const f2 = farms.find(f => f.getAttribute("farmId") === "2");
                
                const fmt = (val) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(val || 0);
                
                document.getElementById('kevinFinance').textContent = fmt(f1?.getAttribute("money"));
                document.getElementById('rayFinance').textContent = fmt(f2?.getAttribute("money"));
            } catch(e) { 
                console.warn("Financial Sync Failed", e); 
                document.getElementById('kevinFinance').textContent = "---";
                document.getElementById('rayFinance').textContent = "---";
            }
        }

        // --- MODULE 1: FIELDS ---
        async function syncFieldBlade(gitPath) {
            try {
                const [fieldsRes, landRes] = await Promise.all([
                    fetch(`${gitPath}/fields.xml?v=${Date.now()}`),
                    fetch(`${gitPath}/farmland.xml?v=${Date.now()}`)
                ]);
                if (!fieldsRes.ok || !landRes.ok) throw new Error("Field data missing");
                const fieldsXml = new DOMParser().parseFromString(await fieldsRes.text(), "text/xml");
                const fieldData = Array.from(fieldsXml.getElementsByTagName("field"));
                
                const activeFields = fieldData.filter(f => (f.getAttribute("fruitType") || "FALLOW").toUpperCase() !== "FALLOW");

                document.getElementById('fieldCount').textContent = `${activeFields.length} ACTIVE ZONES`;
                document.getElementById('fieldMatrixContainer').innerHTML = activeFields.map(f => {
                    const id = f.getAttribute("id") || f.getAttribute("fieldId");
                    const crop = (f.getAttribute("fruitType") || "FALLOW").toUpperCase();
                    const stage = parseInt(f.getAttribute("growthState") || 0);
                    const fert = (parseFloat(f.getAttribute("fertilizedLevel") || 0) * 100).toFixed(0);
                    const weeds = (parseFloat(f.getAttribute("weedState") || 0) * 100).toFixed(0);
                    const stones = (parseFloat(f.getAttribute("stoneLevel") || 0) * 100).toFixed(0);
                    
                    const needsLime = f.getAttribute("needsLime") === "true";
                    const needsPlow = f.getAttribute("needsPlowing") === "true";
                    const isRolled = f.getAttribute("isRolled") === "true";
                    const isMulched = f.getAttribute("isMulched") === "true";
                    
                    const ownerId = f.getAttribute("owner");
                    const ownerName = ownerId === "2" ? "raymystro" : (ownerId === "1" ? "werewolf3788" : "VACANT");
                    const isReady = stage >= 6; 
                    
                    return `<div class="field-card ${isReady ? 'harvest-ready' : ''}">
                        <div class="field-top">
                            <span class="field-id">ZONE ${id}</span>
                            <span class="owner-tag ${ownerName === 'raymystro' ? 'gold' : 'green'}">${ownerName}</span>
                        </div>
                        <div class="field-main-info">
                            <div class="field-crop">${crop}</div>
                            <div class="field-status" style="color:${isReady ? '#22c55e' : '#999'}">${isReady ? '‚óè READY TO HARVEST' : '‚óè GROWTH STAGE: ' + stage}</div>
                        </div>
                        <div class="telemetry-grid">
                            <div class="stat-unit"><label>Fert: ${fert}%</label><div class="bar-bg"><div class="bar-fill" style="width:${fert}%; background:${fert>=100?'#22c55e':'#ffd700'}"></div></div></div>
                            <div class="stat-unit"><label>Weeds: ${weeds}%</label><div class="bar-bg"><div class="bar-fill" style="width:${weeds}%; background:#ff4d4d"></div></div></div>
                            <div class="stat-unit"><label>Stones: ${stones}%</label><div class="bar-bg"><div class="bar-fill" style="width:${stones}%; background:#888"></div></div></div>
                        </div>
                        <div class="requirement-tags">
                            ${needsLime ? '<span class="req-badge lime">LIME</span>' : ''}
                            ${needsPlow ? '<span class="req-badge plow">PLOW</span>' : ''}
                            ${!isRolled && stage === 1 ? '<span class="req-badge roll">ROLL</span>' : ''}
                            ${isMulched ? '<span class="req-badge mulched">MULCHED</span>' : ''}
                        </div>
                    </div>`;
                }).join('');
            } catch (e) { 
                console.warn("Field Sync Failed"); 
                document.getElementById('fieldCount').textContent = "NO DATA";
                document.getElementById('fieldMatrixContainer').innerHTML = "<div style='padding:15px; color:#aaa;'>Waiting for field data...</div>";
            }
        }

        // --- MODULE 2: ANIMALS ---
        async function syncAnimalBlade(gitPath) {
            try {
                const [animRes, placeRes] = await Promise.all([
                    fetch(`${gitPath}/animals.xml?v=${Date.now()}`),
                    fetch(`${gitPath}/placeables.xml?v=${Date.now()}`)
                ]);
                if (!animRes.ok || !placeRes.ok) throw new Error("Animal data missing");
                const xml = new DOMParser().parseFromString(await animRes.text(), "text/xml");
                const placeXml = new DOMParser().parseFromString(await placeRes.text(), "text/xml");
                
                const animals = Array.from(xml.getElementsByTagName("animal"));
                const placeables = Array.from(placeXml.getElementsByTagName("placeable"));
                
                document.getElementById('animalCount').textContent = `${animals.length} ACTIVE HEAD`;
                
                let htmlContent = animals.map(a => {
                    const type = a.getAttribute("type").split('_').pop().toUpperCase();
                    const health = (parseFloat(a.getAttribute("health") || 0) * 100).toFixed(0);
                    const age = a.getAttribute("age") || 0;
                    const food = parseFloat(a.getAttribute("foodLevel") || 0).toFixed(0);
                    const repro = (parseFloat(a.getAttribute("reproductionWeight") || 0) * 100).toFixed(0);
                    const milk = parseFloat(a.getAttribute("milkLevel") || 0).toFixed(0);
                    
                    return `<div class="animal-card ${health < 50 ? 'warning' : ''}">
                        <div class="card-top"><span class="type-tag">${type}</span><span class="age-tag">${age}M</span></div>
                        <div class="telemetry-bars">
                            <label>Health: ${health}%</label><div class="bar-bg"><div class="bar-fill" style="width:${health}%; background:${health<50?'#ff4d4d':'#22c55e'}"></div></div>
                            <label>Repro: ${repro}%</label><div class="bar-bg"><div class="bar-fill" style="width:${repro}%; background:#ffd700"></div></div>
                            <label>Food: ${food}L</label><div class="bar-bg"><div class="bar-fill" style="width:${Math.min(100, (food/5000)*100)}%; background:#00d4ff"></div></div>
                        </div>
                        ${milk > 0 ? `<div class="production-stats"><div class="stat-line">ü•õ MILK: <strong>${milk}L</strong></div></div>` : ''}
                    </div>`;
                }).join('');

                const beeHives = placeables.filter(p => p.getAttribute("filename")?.includes("beeHive"));
                if(beeHives.length > 0) {
                    htmlContent += `<div class="animal-card bee-card">
                        <div class="card-top"><span class="type-tag">BEES</span><span class="age-tag">AUTO</span></div>
                        <div class="production-stats"><div class="stat-line">üçØ HIVES: <strong>${beeHives.length}</strong></div></div>
                    </div>`;
                }
                
                document.getElementById('animalMatrixContainer').innerHTML = htmlContent;
            } catch (e) { 
                console.warn("Animal Sync Failed"); 
                document.getElementById('animalCount').textContent = "NO DATA";
                document.getElementById('animalMatrixContainer').innerHTML = "<div style='padding:15px; color:#aaa;'>Waiting for animal data...</div>";
            }
        }

        // --- MODULE 3: FACTORIES ---
        async function syncFactoryBlade(gitPath) {
            try {
                const res = await fetch(`${gitPath}/placeables.xml?v=${Date.now()}`);
                if (!res.ok) throw new Error("Factory data missing");
                const xml = new DOMParser().parseFromString(await res.text(), "text/xml");
                const factories = Array.from(xml.getElementsByTagName("productionPoint"));
                
                document.getElementById('factoryCount').textContent = `${factories.length} FACILITIES`;
                document.getElementById('factoryMatrixContainer').innerHTML = factories.map(f => {
                    const parent = f.parentElement;
                    const name = parent.getAttribute("filename").split('/').pop().replace('.xml','').toUpperCase();
                    const ownerId = parent.getAttribute("farmId");
                    const ownerName = ownerId === "2" ? "raymystro" : "werewolf3788";
                    
                    const productions = Array.from(f.getElementsByTagName("production"));
                    const storage = Array.from(f.getElementsByTagName("storage")[0]?.children || []);

                    return `<div class="factory-card">
                        <div class="card-top"><span class="factory-id">${name}</span><span class="owner-tag ${ownerName === 'raymystro' ? 'gold' : 'green'}">${ownerName}</span></div>
                        <div class="production-lines">
                            ${productions.map(p => {
                                const pStatus = p.getAttribute("isEnabled") === "true" ? "ACTIVE" : "HALTED";
                                return `<div class="p-line">‚öôÔ∏è ${p.getAttribute("id")}: <strong style="color:${pStatus==='ACTIVE'?'#22c55e':'#ff4d4d'}">${pStatus}</strong></div>`;
                            }).join('')}
                        </div>
                        <div class="storage-matrix">
                            ${storage.map(s => {
                                const amount = parseFloat(s.textContent || 0).toFixed(0);
                                const pct = Math.min(100, (amount / 50000 * 100)).toFixed(0); // Approx capacity
                                return `<div class="stat-unit"><div class="bar-info"><span>${s.tagName.toUpperCase()}</span><span>${amount}L</span></div><div class="bar-bg"><div class="bar-fill" style="width:${pct}%; background:#ffd700"></div></div></div>`;
                            }).join('')}
                        </div>
                    </div>`;
                }).join('');
            } catch (e) { 
                console.warn("Factory Sync Failed"); 
                document.getElementById('factoryCount').textContent = "NO DATA";
                document.getElementById('factoryMatrixContainer').innerHTML = "<div style='padding:15px; color:#aaa;'>Waiting for production data...</div>";
            }
        }

        // --- FLEET SYNC ---
        async function syncFleet(gitPath) {
            try {
                const res = await fetch(`${gitPath}/vehicles.xml?v=${Date.now()}`);
                if (!res.ok) throw new Error("Fleet data missing");
                const xml = new DOMParser().parseFromString(await res.text(), "text/xml");
                const vehicles = Array.from(xml.getElementsByTagName("vehicle")).filter(v => v.getAttribute("farmId") !== "0");
                
                document.getElementById('fleetLog').innerHTML = vehicles.map(v => {
                    let name = v.getAttribute("filename").split('/').pop().replace('.xml','').toUpperCase();
                    const farm = v.getAttribute("farmId") === "1" ? "werewolf3788" : "raymystro";
                    
                    // Enhanced Naming for Pallets/Bags/Bales
                    const unit = v.getElementsByTagName("unit")[0];
                    const fillType = unit ? unit.getAttribute("fillType") : "";
                    
                    if ((name.includes("PALLET") || name.includes("BAG") || name.includes("BALE")) && fillType && fillType !== "UNKNOWN") {
                        name = `${fillType.replace(/_/g, ' ')} ${name.includes("BAG") ? 'BAG' : (name.includes("BALE") ? 'BALE' : 'PALLET')}`;
                    }
                    name = name.replace(/_/g, ' ').replace(/([a-zA-Z])(\d)/g, '$1 $2').trim();

                    const fuelLiters = parseFloat(unit?.getAttribute("fillLevel") || 0);
                    const fuelGal = (fuelLiters * 0.264).toFixed(1); // US Gallons
                    const damage = (parseFloat(v.getElementsByTagName("wearable")[0]?.getAttribute("damage") || 0) * 100).toFixed(0);
                    
                    return `<div style="display:flex; justify-content:space-between; border-bottom:1px solid #333; padding:5px;">
                        <span>${name}</span><span style="color:${farm==='werewolf3788'?'#7cfc00':'#ffd700'}">${farm}</span>
                        <span>${fuelGal} gal</span><span style="color:${damage>10?'#ff4d4d':'#22c55e'}">${damage}% Dmg</span>
                    </div>`;
                }).join('');
            } catch(e) { 
                console.warn("Fleet Sync Failed"); 
                document.getElementById('fleetLog').innerHTML = "<div style='padding:10px; color:#aaa;'>Waiting for vehicle data...</div>";
            }
        }

        // --- MODS SYNC ---
        function syncMods(xml) {
            const mods = Array.from(xml.getElementsByTagName("Mod"));
            const container = document.getElementById('modsLog');
            
            container.innerHTML = mods.map(m => {
                const name = m.textContent;
                const author = m.getAttribute("author");
                const version = m.getAttribute("version");
                return `<div style="background:rgba(255,255,255,0.05); padding:8px; border-radius:4px; border-left: 3px solid #ffd700;">
                    <div style="font-weight:bold; color:#fff; font-size:0.8rem;">${name}</div>
                    <div style="font-size:0.7rem; color:#aaa;">v${version} | ${author}</div>
                </div>`;
            }).join('') || '<div style="padding:10px; color:#aaa;">No Active Mods Detected</div>';
        }

        // --- TROPHY SYNC ---
        async function syncTrophies() {
            await fetchTrophies("OneLIVIDMAN", "trophyLogRay");
            await fetchTrophies("Werewolf3788", "trophyLogKevin");
        }

        async function fetchTrophies(username, elementId) {
            try {
                const feedUrl = `https://psntrophyleaders.com/user/view/${username}/rss`;
                const res = await fetch(`https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(feedUrl)}`);
                const data = await res.json();
                
                if(data.status === 'ok') {
                    // Filter for Farming Simulator related trophies
                    const fsTrophies = data.items.filter(item => 
                        (item.description && item.description.includes("Farming Simulator")) || 
                        (item.title && item.title.includes("Farming Simulator"))
                    );

                    document.getElementById(elementId).innerHTML = fsTrophies.map(item => {
                        const date = new Date(item.pubDate).toLocaleDateString();
                        return `<div style="display:flex; justify-content:space-between; border-bottom:1px solid rgba(255,255,255,0.1); padding:8px;">
                            <span style="color:#fff; font-size:0.8rem;">${item.title}</span>
                            <span style="color:#ffd700; font-size:0.7rem;">${date}</span>
                        </div>`;
                    }).join('') || '<div style="padding:10px; color:#aaa;">No Recent Farming Simulator Trophies Found</div>';
                } else {
                    document.getElementById(elementId).innerHTML = '<div style="padding:10px; color:#ff4d4d;">Uplink Failed (Profile Private or Not Found)</div>';
                }
            } catch(e) { 
                console.warn(`Trophy Sync Failed for ${username}`);
                document.getElementById(elementId).innerHTML = '<div style="padding:10px; color:#ff4d4d;">Connection Error</div>';
            }
        }

        // --- SHEET SYNC ---
        async function syncModSheet() {
            const url = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTZipdOjDkX5aeUvTiJHGSc9EVkhC_12IimhVXPCNDPwQlVq5759RIXRBKtZpWPkSoQN-gi7hIkblS2/pub?output=csv";
            try {
                const res = await fetch(url);
                const text = await res.text();
                const rows = parseCSV(text);
                
                const container = document.getElementById('sheetModsLog');
                if(rows.length === 0) {
                    container.innerHTML = '<div style="padding:10px; color:#aaa;">No data found in sheet</div>';
                    return;
                }

                container.innerHTML = rows.map(row => {
                    const keys = Object.keys(row);
                    const findKey = (k) => keys.find(key => key.toLowerCase().includes(k));
                    
                    const name = row[findKey('name') || findKey('mod') || keys[0]] || 'Unknown';
                    let img = row[findKey('image') || findKey('img') || findKey('pic') || findKey('screenshot')] || '';
                    const desc = row[findKey('desc') || findKey('author') || findKey('version') || keys[1]] || '';
                    const downloadUrl = row[findKey('url') || findKey('link') || findKey('download') || findKey('href')] || '';
                    
                    // Fallback: Scan all columns for image URL if not found by header
                    if (!img || !img.startsWith('http')) {
                        const potentialImg = Object.values(row).find(val => 
                            val && typeof val === 'string' && val.startsWith('http') && 
                            /\.(jpg|jpeg|png|webp|gif)$/i.test(val)
                        );
                        if (potentialImg) img = potentialImg;
                    }
                    
                    // Upgrade HTTP to HTTPS to prevent mixed content blocking and handle case sensitivity
                    if (img && img.toLowerCase().startsWith('http')) {
                        img = img.replace(/^http:\/\//i, 'https://');
                    }
                    
                    const imgHtml = (img && img.toLowerCase().startsWith('http')) ? 
                        `<div style="width:100%; height:120px; background:url('${img}') center/cover no-repeat; border-radius:4px; margin-bottom:8px;"></div>` : '';
                    
                    const cardContent = `
                        ${imgHtml}
                        <div style="font-weight:900; color:#fff; font-size:0.85rem; margin-bottom:4px;">${name}</div>
                        <div style="font-size:0.75rem; color:#aaa;">${desc}</div>
                    `;

                    if (downloadUrl && downloadUrl.toLowerCase().startsWith('http')) {
                        return `<a href="${downloadUrl}" target="_blank" style="text-decoration:none; display:block;">
                            <div style="background:rgba(255,255,255,0.05); padding:10px; border-radius:6px; border: 1px solid rgba(255,255,255,0.1); transition: all 0.2s ease;" onmouseover="this.style.borderColor='#ffd700'; this.style.background='rgba(255,215,0,0.1)'" onmouseout="this.style.borderColor='rgba(255,255,255,0.1)'; this.style.background='rgba(255,255,255,0.05)'">
                                ${cardContent}
                                <div style="margin-top:8px; font-size:0.7rem; color:#ffd700; text-align:right; font-weight:bold;">‚¨á DOWNLOAD</div>
                            </div>
                        </a>`;
                    }

                    return `<div style="background:rgba(255,255,255,0.05); padding:10px; border-radius:6px; border: 1px solid rgba(255,255,255,0.1);">
                        ${cardContent}
                    </div>`;
                }).join('');
            } catch(e) { 
                console.warn("Sheet Sync Failed", e);
                document.getElementById('sheetModsLog').innerHTML = '<div style="padding:10px; color:#ff4d4d;">Failed to load sheet data</div>';
            }
        }

        function parseCSV(str) {
            const lines = str.trim().split(/\r?\n/);
            if (lines.length < 2) return [];
            const headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, ''));
            
            return lines.slice(1).map(line => {
                const values = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(v => v.trim().replace(/^"|"$/g, ''));
                return headers.reduce((obj, header, i) => {
                    obj[header] = values[i] || '';
                    return obj;
                }, {});
            });
        }
    </script>
</body>
</html>
